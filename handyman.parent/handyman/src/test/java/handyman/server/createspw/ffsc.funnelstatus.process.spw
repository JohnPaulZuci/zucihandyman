process "ffsc.funnelstatus.process"
{
	try 
	{
	
		transform as "create-table" on "${ffsc-sqldb}" using
		{"
		
			create table unApprovedLeads_${process-id} as SELECT intMarketerLeadID,vcADID,intTransactionID,intLenderID,vcReason,bitApproved,dtCreated,bitTesting,bitIsWeekendLead,decSecondsToProcess,decLeadCost,JobTitle,Supervisor,Address,BankABARouting,BankName,CheckDeposit,City,CompanyName,DOB_Month,DOB_Year,Email,FirstName,LastName,License,LicenseState,SSN,State,Zip,TakeHomePay,EmployerPhoneNumber,AccountType,PayPeriod,CelNumber,CurrentlyEmployed,DateHired_Month,DateHired_Year,Months_At_Address,IsMilitary,Existing,BrowserVersion,OSVersion,IPAddress,RequestedAmount FROM tblMarketerLead WHERE intTransactionID is NULL;
			
			create table lead_trans_${process-id} as SELECT  lead.intMarketerLeadID,lead.vcADID,lead.intTransactionID,lead.intLenderID,lead.vcReason,lead.bitApproved,lead.dtCreated,lead.bitTesting,lead.bitIsWeekendLead,lead.decSecondsToProcess,lead.decLeadCost,lead.JobTitle,lead.Supervisor,lead.Address,lead.BankABARouting,lead.BankName,lead.CheckDeposit,lead.City,lead.CompanyName,lead.DOB_Month,lead.DOB_Year,lead.Email,lead.FirstName,lead.LastName,lead.License,lead.LicenseState,lead.SSN,lead.State,lead.Zip,lead.TakeHomePay,lead.EmployerPhoneNumber,lead.AccountType,lead.PayPeriod,lead.CelNumber,lead.CurrentlyEmployed,lead.DateHired_Month,lead.DateHired_Year,lead.Months_At_Address,lead.IsMilitary,lead.Existing,lead.RequestedAmount,lead.BrowserVersion,lead.OSVersion,lead.IPAddress,trans.bitComplete,trans.intCustomerID,trans.intTransactionStatusID,trans.intAmountRequested,trans.intLenderUserID,trans.intPaperworkStatusID,trans.vcMissingPaperwork,trans.bitAutoDefer,trans.vcNotes,trans.intTransactionExceptionID,trans.intCollectionsLenderUserID,trans.dtAgreed,trans.decPaymentAmount,trans.decCSOFeeAmount,trans.decLastPaymentAmount,trans.intTransactionCategoryID,trans.intTransactionDenialReasonID,trans.bitPossibleFraud,trans.dtDateSigned,trans.bitAcceptedNoteDisclosure,trans.bitAcceptedPreauthorizedACH,trans.bitAcceptedBorrowerIDStatement,trans.bitAcceptedConsentToAssignWages,trans.bitMilitaryIAm,trans.bitBVPass,trans.bitDLOverride,trans.bitApprovalAutoDefer,trans.vcCustomMissingPaperwork,trans.intLenderProductID,trans.intAmountRefinanced,trans.bitACH,trans.intRefiTransactionID,trans.numSettlement,trans.bitMLAPass,trans.dtSettlementDate FROM tblMarketerLead lead  INNER JOIN tblTransaction trans ON trans.intTransactionID = lead.intTransactionID;
			
			create table ApprovedLeads_${process-id} as SELECT  appr.intMarketerLeadID,appr.vcADID,appr.intTransactionID,appr.intLenderID,appr.vcReason,appr.bitApproved,appr.dtCreated,appr.bitTesting,appr.bitIsWeekendLead,appr.decSecondsToProcess,appr.decLeadCost,appr.JobTitle,appr.Supervisor,appr.Address,appr.BankABARouting,appr.BankName,appr.CheckDeposit,appr.City,appr.CompanyName,appr.DOB_Month,appr.DOB_Year,appr.Email,appr.FirstName,appr.LastName,appr.License,appr.LicenseState,appr.SSN,appr.State,appr.Zip,appr.TakeHomePay,appr.EmployerPhoneNumber,appr.AccountType,appr.PayPeriod,appr.CelNumber,appr.CurrentlyEmployed,appr.DateHired_Month,appr.DateHired_Year,appr.Months_At_Address,appr.IsMilitary,appr.Existing,appr.RequestedAmount,appr.bitComplete,appr.intCustomerID,appr.intTransactionStatusID,appr.BrowserVersion,appr.OSVersion,appr.IPAddress,appr.intAmountRequested,appr.intLenderUserID,appr.intPaperworkStatusID,appr.vcMissingPaperwork,appr.bitAutoDefer,appr.vcNotes,appr.intTransactionExceptionID,appr.intCollectionsLenderUserID,appr.dtAgreed,appr.decPaymentAmount,appr.decCSOFeeAmount,appr.decLastPaymentAmount,appr.intTransactionCategoryID,appr.intTransactionDenialReasonID,appr.bitPossibleFraud,appr.bitAcceptedNoteDisclosure,appr.bitAcceptedPreauthorizedACH,appr.bitAcceptedBorrowerIDStatement,appr.bitAcceptedConsentToAssignWages,appr.bitMilitaryIAm,appr.bitBVPass,appr.bitDLOverride,appr.bitApprovalAutoDefer,appr.vcCustomMissingPaperwork,appr.intLenderProductID,appr.intAmountRefinanced,appr.bitACH,appr.intRefiTransactionID,appr.numSettlement,appr.bitMLAPass,appr.dtSettlementDate,cust.intSolicitNewLoan,cust.dtSolicitNewLoan,cust.dtSolicitationProcessed,cust.intStateID,cust.dtMovedIn,cust.vcEmail,cust.bitBadEmail,cust.vcEmail2,cust.bitBadEmail2,cust.vcCellPhone,cust.vcCellPhoneType,cust.vcFax,cust.vcDriversLicenseNumber,cust.intDriversLicenseStateID,cust.vcOwnRent,cust.bitEmployed,cust.bitMakes1200,cust.bitDirectDepositAccount,cust.bitUSResident,cust.bitSendOffers,cust.bitSend3PartyOffers,cust.intBankStatusID,cust.vcBankCity,cust.intBankStateID,cust.dtBankChange,cust.vcABANumber,cust.vcAcctType,cust.intEmploymentStatus,cust.vcEmployerNote,cust.vcEmployer,cust.vcJobTitle,cust.vcSupervisor,cust.vcWorkPhoneType,cust.vcWorkPhone2Type,cust.vcWorkPhone3Type,cust.intTakeHomePay,cust.intEmploymentShiftID,cust.dtEmployed,cust.intPayFrequencyID,cust.intActualPayFrequencyID,cust.dtPayStartDate,cust.vcPayNote,cust.bitAgreement,cust.vcSpouseCellPhone,cust.vcSpouseEmployer,cust.vcSpouseWorkPhone,cust.intSpouseTakeHomePay,cust.intSpouseActualPayFrequencyID,cust.vcSpouseNotes,cust.bitLabelPrinted,cust.intApprovedApps,cust.bitIsMilitaryPersonal,cust.dtCollWorked,cust.bitBadAddress,cust.bitPaperworkOnFile,cust.dtDateSigned,cust.bitFraud,cust.dtCellPhoneVerified,cust.dtAddressVerified FROM lead_trans_${process-id} appr  INNER JOIN tblCustomers cust ON cust.intCustomerID = appr.intCustomerID; 
			
			create table FunnelLeads_${process-id} as SELECT intMarketerLeadID,vcADID,intTransactionID,intLenderID,vcReason,bitApproved,dtCreated,bitTesting,bitIsWeekendLead,decSecondsToProcess,decLeadCost,JobTitle,Supervisor,Address,BankABARouting,BankName,CheckDeposit,City,CompanyName,DOB_Month,DOB_Year,Email,FirstName,LastName,License,LicenseState,SSN,State,Zip,TakeHomePay,BrowserVersion,OSVersion,IPAddress,EmployerPhoneNumber,AccountType,PayPeriod,CelNumber,CurrentlyEmployed,DateHired_Month,DateHired_Year,Months_At_Address,IsMilitary,Existing,RequestedAmount,bitComplete,intCustomerID,intTransactionStatusID,intAmountRequested,intLenderUserID,intPaperworkStatusID,vcMissingPaperwork,bitAutoDefer,vcNotes,intTransactionExceptionID,intCollectionsLenderUserID,dtAgreed,decPaymentAmount,decCSOFeeAmount,decLastPaymentAmount,intTransactionCategoryID,intTransactionDenialReasonID,bitAcceptedNoteDisclosure,bitAcceptedPreauthorizedACH,bitAcceptedBorrowerIDStatement,bitAcceptedConsentToAssignWages,bitMilitaryIAm,bitBVPass,bitDLOverride,bitApprovalAutoDefer,vcCustomMissingPaperwork,intLenderProductID,intAmountRefinanced,bitACH,intRefiTransactionID,numSettlement,bitMLAPass,dtSettlementDate,intSolicitNewLoan,dtSolicitNewLoan,dtSolicitationProcessed,intStateID,dtMovedIn,vcEmail,bitBadEmail,vcEmail2,bitBadEmail2,vcCellPhone,vcCellPhoneType,vcFax,vcDriversLicenseNumber,intDriversLicenseStateID,vcOwnRent,bitEmployed,bitMakes1200,bitDirectDepositAccount,bitUSResident,bitSendOffers,bitSend3PartyOffers,intBankStatusID,vcBankCity,intBankStateID,dtBankChange,vcABANumber,vcAcctType,intEmploymentStatus,vcEmployerNote,vcEmployer,vcJobTitle,vcSupervisor,vcWorkPhoneType,vcWorkPhone2Type,vcWorkPhone3Type,intTakeHomePay,intEmploymentShiftID,dtEmployed,intPayFrequencyID,intActualPayFrequencyID,dtPayStartDate,vcPayNote,bitAgreement,vcSpouseCellPhone,vcSpouseEmployer,vcSpouseWorkPhone,intSpouseTakeHomePay,intSpouseActualPayFrequencyID,vcSpouseNotes,bitLabelPrinted,intApprovedApps,bitIsMilitaryPersonal,dtCollWorked,bitBadAddress,bitPaperworkOnFile,dtDateSigned,bitFraud,dtCellPhoneVerified,dtAddressVerified,bitPossibleFraud,(CASE WHEN intTransactionStatusID IN('7' ,'10','11', '12' ) THEN'IrregularCustomers' WHEN intTransactionStatusID IN('0' ,'2') THEN 'PendingCustomers' WHEN intTransactionStatusID IN('3' ,'4') THEN 'DeclinedCustomers' WHEN intTransactionStatusID IN('5' ,'8') THEN 'UnprocessedCustomers' WHEN intTransactionStatusID IN('6') THEN 'IdealCustomers'  WHEN intTransactionStatusID IN('1') THEN 'ApprovedCustomers' end) as 'Type' FROM ApprovedLeads_${process-id};
			
			create table Funnel_${process-id} as SELECT Type,decLeadCost,JobTitle,Supervisor,Address,BankName,CheckDeposit,City,CompanyName,DOB_Year,State,Zip,TakeHomePay,AccountType,PayPeriod,LicenseState,CurrentlyEmployed,DateHired_Year,Months_At_Address,Existing,IsMilitary,RequestedAmount,intTakeHomePay,BrowserVersion,OSVersion,IPAddress,dtCreated,bitApproved,bitTesting,bitIsWeekendLead,decSecondsToProcess,BankABARouting,DOB_Month,Email,FirstName,LastName,License,SSN,EmployerPhoneNumber,CelNumber,DateHired_Month,bitComplete,intTransactionStatusID,intAmountRequested,intLenderUserID,intPaperworkStatusID,vcMissingPaperwork,bitAutoDefer,vcNotes,intTransactionExceptionID,intCollectionsLenderUserID,dtAgreed,decPaymentAmount,decCSOFeeAmount,vcReason,decLastPaymentAmount,intTransactionCategoryID,intTransactionDenialReasonID,bitAcceptedNoteDisclosure,bitAcceptedPreauthorizedACH,bitAcceptedBorrowerIDStatement,bitAcceptedConsentToAssignWages,bitMilitaryIAm,bitBVPass,bitDLOverride,bitApprovalAutoDefer,vcCustomMissingPaperwork,intLenderProductID,intAmountRefinanced,bitACH,intRefiTransactionID,numSettlement,bitMLAPass,dtSettlementDate,intSolicitNewLoan,dtSolicitNewLoan,dtSolicitationProcessed,intStateID,dtMovedIn,vcEmail,bitBadEmail,vcEmail2,bitBadEmail2,vcCellPhone,vcCellPhoneType,vcFax,vcDriversLicenseNumber,intDriversLicenseStateID,vcOwnRent,bitEmployed,bitMakes1200,bitDirectDepositAccount,bitUSResident,bitSendOffers,bitSend3PartyOffers,intBankStatusID,vcBankCity,dtBankChange,vcABANumber,vcAcctType,intEmploymentStatus,vcEmployerNote,vcEmployer,vcJobTitle,vcSupervisor,vcWorkPhoneType,vcWorkPhone2Type,vcWorkPhone3Type,intEmploymentShiftID,dtEmployed,intPayFrequencyID,intActualPayFrequencyID,dtPayStartDate,vcPayNote,bitAgreement,vcSpouseCellPhone,vcSpouseEmployer,vcSpouseWorkPhone,intSpouseTakeHomePay,intSpouseActualPayFrequencyID,vcSpouseNotes,bitLabelPrinted,intApprovedApps,bitIsMilitaryPersonal,dtCollWorked,bitBadAddress,bitPaperworkOnFile,dtDateSigned,bitFraud,dtCellPhoneVerified,dtAddressVerified,bitPossibleFraud from FunnelLeads_${process-id};	
			
			ALTER TABLE Funnel_${process-id} MODIFY COLUMN intLenderProductID INT NULL;
			ALTER TABLE Funnel_${process-id} MODIFY COLUMN bitACH BIT NULL;
			ALTER TABLE Funnel_${process-id} MODIFY COLUMN intDriversLicenseStateID  VARCHAR(2) NULL;
			ALTER TABLE Funnel_${process-id} MODIFY COLUMN intLenderProductID INT NULL;
			ALTER TABLE Funnel_${process-id} MODIFY COLUMN Type VARCHAR(100) NULL;

		
			insert into Funnel_${process-id}(decLeadCost,JobTitle,Supervisor,Address,BankName,CheckDeposit,City,CompanyName,DOB_Year,State,Zip,TakeHomePay,AccountType,PayPeriod,LicenseState,CurrentlyEmployed,DateHired_Year,Months_At_Address,Existing,IsMilitary,RequestedAmount,BrowserVersion,OSVersion,IPAddress,dtCreated,bitApproved,bitTesting,bitIsWeekendLead,decSecondsToProcess,BankABARouting,DOB_Month,Email,FirstName,LastName,License,SSN,EmployerPhoneNumber,CelNumber,DateHired_Month,bitComplete,intTransactionStatusID,intAmountRequested,intLenderUserID,intPaperworkStatusID,vcMissingPaperwork,bitAutoDefer,vcNotes,intTransactionExceptionID,intCollectionsLenderUserID,dtAgreed,decPaymentAmount,decCSOFeeAmount,vcReason,decLastPaymentAmount,intTransactionCategoryID,intTransactionDenialReasonID,bitAcceptedNoteDisclosure,bitAcceptedPreauthorizedACH,bitAcceptedBorrowerIDStatement,bitAcceptedConsentToAssignWages,bitMilitaryIAm,bitBVPass,bitDLOverride,bitApprovalAutoDefer,vcCustomMissingPaperwork,intLenderProductID,intAmountRefinanced,bitACH,intRefiTransactionID,numSettlement,bitMLAPass,dtSettlementDate,intSolicitNewLoan,dtSolicitNewLoan,dtSolicitationProcessed,intStateID,dtMovedIn,vcEmail,bitBadEmail,vcEmail2,bitBadEmail2,vcCellPhone,vcCellPhoneType,vcFax,vcDriversLicenseNumber,intDriversLicenseStateID,vcOwnRent,bitEmployed,bitMakes1200,bitDirectDepositAccount,bitUSResident,bitSendOffers,bitSend3PartyOffers,intBankStatusID,vcBankCity,dtBankChange,vcABANumber,vcAcctType,intEmploymentStatus,vcEmployerNote,vcEmployer,vcJobTitle,vcSupervisor,vcWorkPhoneType,vcWorkPhone2Type,vcWorkPhone3Type,intEmploymentShiftID,dtEmployed,intPayFrequencyID,intActualPayFrequencyID,dtPayStartDate,vcPayNote,bitAgreement,vcSpouseCellPhone,vcSpouseEmployer,vcSpouseWorkPhone,intSpouseTakeHomePay,intSpouseActualPayFrequencyID,vcSpouseNotes,bitLabelPrinted,intApprovedApps,bitIsMilitaryPersonal,dtCollWorked,bitBadAddress,bitPaperworkOnFile,dtDateSigned,bitFraud,dtCellPhoneVerified,dtAddressVerified,bitPossibleFraud,Type)  SELECT null decLeadCost,null JobTitle,null Supervisor,null Address,null BankName,null CheckDeposit,null City,null CompanyName,null DOB_Year,null State,null Zip,null TakeHomePay,null AccountType,null PayPeriod,null LicenseState,null CurrentlyEmployed,null DateHired_Year,null Months_At_Address,null Existing,null IsMilitary,null RequestedAmount,null BrowserVersion,null OSVersion,null IPAddress,null dtCreated,null bitApproved,null bitTesting,null bitIsWeekendLead,null decSecondsToProcess,null BankABARouting,null DOB_Month,null Email,null FirstName,null LastName,null License,null SSN,null EmployerPhoneNumber,null CelNumber,null DateHired_Month,null bitComplete,null intTransactionStatusID,null intAmountRequested,null intLenderUserID,null intPaperworkStatusID,null vcMissingPaperwork,null bitAutoDefer,null vcNotes,null intTransactionExceptionID,null intCollectionsLenderUserID,null dtAgreed,null decPaymentAmount,null decCSOFeeAmount,null vcReason,null decLastPaymentAmount,null intTransactionCategoryID,null intTransactionDenialReasonID,null bitAcceptedNoteDisclosure,null bitAcceptedPreauthorizedACH,null bitAcceptedBorrowerIDStatement,null bitAcceptedConsentToAssignWages,null bitMilitaryIAm,null bitBVPass,null bitDLOverride,null bitApprovalAutoDefer,null vcCustomMissingPaperwork,null intLenderProductID,null intAmountRefinanced,null bitACH,null intRefiTransactionID,null numSettlement,null bitMLAPass,null dtSettlementDate,null intSolicitNewLoan,null dtSolicitNewLoan,null dtSolicitationProcessed,null intStateID,null dtMovedIn,null vcEmail,null bitBadEmail,null vcEmail2,null bitBadEmail2,null vcCellPhone,null vcCellPhoneType,null vcFax,null vcDriversLicenseNumber,null intDriversLicenseStateID,null vcOwnRent,null bitEmployed,null bitMakes1200,null bitDirectDepositAccount,null bitUSResident,null bitSendOffers,null bitSend3PartyOffers,null intBankStatusID,null vcBankCity,null dtBankChange,null vcABANumber,null vcAcctType,null intEmploymentStatus,null vcEmployerNote,null vcEmployer,null vcJobTitle,null vcSupervisor,null vcWorkPhoneType,null vcWorkPhone2Type,null vcWorkPhone3Type,null intEmploymentShiftID,null dtEmployed,null intPayFrequencyID,null intActualPayFrequencyID,null dtPayStartDate,null vcPayNote,null bitAgreement,null vcSpouseCellPhone,null vcSpouseEmployer,null vcSpouseWorkPhone,null intSpouseTakeHomePay,null intSpouseActualPayFrequencyID,null vcSpouseNotes,null bitLabelPrinted,null intApprovedApps,null bitIsMilitaryPersonal,null dtCollWorked,null bitBadAddress,null bitPaperworkOnFile,null dtDateSigned,null bitFraud,null dtCellPhoneVerified,null dtAddressVerified,null bitPossibleFraud,'unApprovedLeads' FROM unApprovedLeads_${process-id} WHERE intTransactionID is NULL;

			    		
		"}on-condition if "true"=="true" 
	transform as "update into process" on "${config/ffsc}" using
		{"
		update spw_process_config set value='Funnel_${process-id}' where process='sample.macro' and variable='table_name';

                update spw_process_config set value='${process-id}' where process='sample.macro' and variable='process_id';	
		"}on-condition if "true"=="true"

		
	}
	catch
	{
	transform as "update into process" on "${config/ffsc}" using
		{"
		update spw_process_config set value='Funnel_${process-id}' where process='sample.macro' and variable='table_name';

                update spw_process_config set value='${process-id}' where process='sample.macro' and variable='process_id';	
		"}on-condition if "true"=="true"
	}
	finally
	{
	transform as "update into process" on "${config/ffsc}" using
		{"
		update spw_process_config set value='Funnel_${process-id}' where process='sample.macro' and variable='table_name';

                update spw_process_config set value='${process-id}' where process='sample.macro' and variable='process_id';	
		"}on-condition if "true"=="true"
	
	}
}
